<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ride — Прототип</title>

  <!-- Яндекс.Карты -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=f21d3774-1629-45e0-b30f-fe8c5ea7f304&lang=ru_RU"></script>

  <!-- Icons & font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0A0A0A; --card:#1E1E1E; --accent:#FFC107; --accent-2:#FF9800;
      --text:#FFF; --muted:#B0B0B0; --border:#333;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:"Montserrat",sans-serif; background:linear-gradient(135deg,var(--bg),#141414);
      color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:480px;margin:0 auto;padding:0 14px 120px;}
    header{
      position:sticky;top:0;background:rgba(10,10,10,0.95);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,193,7,0.08);
      z-index:30;padding:14px 0;box-shadow:0 6px 20px rgba(0,0,0,0.4)
    }
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .logo{display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px;background:linear-gradient(135deg,var(--accent),var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .logo-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#000}
    .user-actions{display:flex;align-items:center;gap:10px}
    .action-btn{width:40px;height:40px;border-radius:50%;border:none;background:rgba(255,255,255,0.06);color:var(--text);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .profile-badge{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,193,7,0.16);color:#000;font-weight:700;display:none}

    .main-content{padding:18px 0}
    .card{background:var(--card);border-radius:14px;padding:18px;margin-bottom:18px;border:1px solid var(--border);box-shadow:0 8px 28px rgba(0,0,0,0.35)}
    .map-container{height:380px;border-radius:14px;overflow:hidden;position:relative;box-shadow:0 14px 40px rgba(0,0,0,0.5)}
    #map{width:100%;height:100%}

    .location-controls{position:absolute;right:12px;bottom:12px;display:flex;flex-direction:column;gap:10px;z-index:50}
    .location-btn{width:46px;height:46px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#000;font-size:16px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.35)}
    .location-btn:hover{transform:translateY(-3px)}

    .input-group{position:relative;margin-bottom:14px}
    .input-field{width:100%;padding:14px 16px 14px 46px;border-radius:12px;background:rgba(30,30,30,0.65);border:1px solid var(--border);color:var(--text);font-size:15px}
    .input-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--accent)}

    .payment-methods{display:flex;gap:10px;margin:12px 0}
    .payment-method{flex:1;padding:10px;border-radius:12px;border:1px solid var(--border);background:rgba(30,30,30,0.5);display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer}
    .payment-method.active{border-color:var(--accent);background:rgba(255,193,7,0.08);transform:translateY(-2px)}

    .price-estimate{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:rgba(20,20,20,0.6);border:1px solid var(--border)}
    .price-value{font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent-2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:18px}

    .btn{display:block;width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#000;font-weight:700;cursor:pointer;font-size:15px}
    .btn:active{transform:translateY(1px)}
    .btn-outline{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:10px;border-radius:10px;cursor:pointer}

    .tab-container{display:flex;background:rgba(20,20,20,0.7);padding:6px;border-radius:12px;gap:8px;margin-bottom:12px}
    .tab{flex:1;padding:10px;border-radius:8px;text-align:center;cursor:pointer;background:transparent}
    .tab.active{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#000}

    .history-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border);gap:12px}
    .history-route{font-weight:600}
    .history-details{color:var(--muted);font-size:13px}

    footer{position:fixed;left:0;right:0;bottom:0;background:rgba(10,10,10,0.95);padding:12px 0;border-top:1px solid rgba(255,193,7,0.08);display:flex;justify-content:center;gap:12px}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(6px);align-items:center;justify-content:center;z-index:120}
    .modal .modal-content{width:100%;max-width:420px;padding:18px;border-radius:14px;background:var(--card);border:1px solid var(--border)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .close-modal{background:rgba(255,255,255,0.06);border:none;width:36px;height:36px;border-radius:50%;cursor:pointer}
    .small{font-size:13px;color:var(--muted);margin-top:8px}

    .notification{position:fixed;right:18px;top:18px;padding:12px 14px;border-radius:10px;background:var(--card);border-left:4px solid var(--accent);box-shadow:0 12px 28px rgba(0,0,0,0.45);transform:translateX(110%);transition:transform .35s;z-index:150}
    .notification.show{transform:translateX(0)}
    .notification.error{border-left-color:#EF5350}

    /* responsive */
    @media (max-width:420px){.container{padding:0 10px}.map-container{height:320px}}
  </style>
</head>
<body>
  <header>
    <div class="container header-row">
      <div class="logo"><div class="logo-icon"><i class="fas fa-taxi"></i></div>Ride</div>
      <div class="user-actions">
        <!-- Тариф убран — кнопка удалена -->
        <div id="profileBadge" class="profile-badge">U</div>
        <button class="action-btn" id="notificationsBtn" title="Уведомления"><i class="fas fa-bell"></i></button>
        <button class="action-btn" id="menuBtn" title="Профиль / Вход"><i class="fas fa-user"></i></button>
      </div>
    </div>
  </header>

  <main class="container main-content">
    <!-- MAP -->
    <div class="map-container card">
      <div id="map"></div>
      <div class="location-controls">
        <button class="location-btn" id="locateMeBtn" title="Мое местоположение"><i class="fas fa-location-arrow"></i></button>
        <button class="location-btn" id="zoomInBtn" title="Приблизить"><i class="fas fa-plus"></i></button>
        <button class="location-btn" id="zoomOutBtn" title="Отдалить"><i class="fas fa-minus"></i></button>
      </div>
    </div>

    <!-- ORDER CARD -->
    <section class="card">
      <div class="input-group">
        <span class="input-icon"><i class="fas fa-circle"></i></span>
        <input id="fromInput" class="input-field" placeholder="Откуда" value="Житикара" />
      </div>
      <div class="input-group">
        <span class="input-icon"><i class="fas fa-location-dot"></i></span>
        <input id="toInput" class="input-field" placeholder="Куда" />
      </div>

      <div class="payment-methods">
        <div class="payment-method active" data-method="cash"><i class="fas fa-money-bill-wave"></i><div style="font-size:13px">Наличные</div></div>
        <div class="payment-method" data-method="transfer"><i class="fas fa-credit-card"></i><div style="font-size:13px">Перевод</div></div>
        <div class="payment-method" data-method="bonus"><i class="fas fa-gift"></i><div style="font-size:13px">Бонусы</div></div>
      </div>

      <div class="price-estimate">
        <div>Примерная стоимость:</div>
        <div class="price-value" id="priceValue">—</div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <input id="manualPrice" class="input-field" placeholder="Ваша цена (опционально)" style="flex:1;padding-left:12px" />
        <button id="offerPriceBtn" class="btn" style="width:140px">Предложить</button>
      </div>

      <button id="orderBtn" class="btn" style="margin-top:14px"><i class="fas fa-taxi"></i> Заказать такси</button>
    </section>

    <!-- Tabs -->
    <div class="tab-container">
      <div class="tab active" data-tab="history">История</div>
      <div class="tab" data-tab="promo">Промокоды</div>
      <div class="tab" data-tab="profileTab">Профиль</div>
    </div>

    <!-- Tab contents -->
    <div id="historyTab" class="tab-content active card">
      <div class="section-title" style="display:flex;justify-content:space-between;align-items:center">
        История поездок
        <button id="clearHistory" class="btn-outline" style="padding:8px 10px">Очистить</button>
      </div>
      <div id="historyList"></div>
      <div id="noHistory" class="small" style="display:none">История пуста</div>
    </div>

    <div id="promoTab" class="tab-content card" style="display:none">
      <div class="section-title">Промокоды</div>
      <div class="input-group">
        <span class="input-icon"><i class="fas fa-ticket-alt"></i></span>
        <input id="promoInput" class="input-field" placeholder="Введите промокод" />
      </div>
      <button id="applyPromo" class="btn btn-outline">Применить</button>

      <div style="margin-top:12px" class="small">Доступные: <strong>FIRSTRIDE</strong> — 50% на первую поездку</div>
    </div>

    <div id="profileTab" class="tab-content card" style="display:none">
      <div class="section-title">Анкета профиля</div>
      <div class="input-group"><span class="input-icon"><i class="fas fa-id-card"></i></span><input id="profileName" class="input-field" placeholder="Имя и фамилия" /></div>
      <div class="input-group"><span class="input-icon"><i class="fas fa-phone"></i></span><input id="profilePhone" class="input-field" placeholder="Телефон" /></div>
      <div class="input-group"><span class="input-icon"><i class="fas fa-envelope"></i></span><input id="profileEmail" class="input-field" placeholder="E-mail (необязательно)" /></div>

      <div style="display:flex;gap:8px;margin-bottom:12px">
        <select id="profileBank" class="input-field" style="padding-left:12px">
          <option value="">Выберите банк</option>
          <option>Kaspi</option>
          <option>Halyk</option>
          <option>Forte</option>
        </select>
        <select id="profileRole" class="input-field" style="padding-left:12px;width:160px">
          <option value="passenger">Пассажир</option>
          <option value="driver">Водитель</option>
        </select>
      </div>

      <button id="saveProfileBtn" class="btn">Сохранить анкету</button>
      <button id="logoutBtn" class="btn btn-outline" style="margin-top:10px;display:none">Выйти</button>
    </div>
  </main>

  <footer>
    <a href="#" class="footer-link" style="color:var(--muted);text-decoration:none"><i class="fas fa-home"></i></a>
    <a href="#" class="footer-link" style="color:var(--muted);text-decoration:none"><i class="fas fa-history"></i></a>
    <a href="#" class="footer-link" style="color:var(--muted);text-decoration:none"><i class="fas fa-wallet"></i></a>
    <a href="#" class="footer-link" style="color:var(--muted);text-decoration:none"><i class="fas fa-user"></i></a>
  </footer>

  <!-- Modals -->
  <div id="loginModal" class="modal" aria-hidden>
    <div class="modal-content">
      <div class="modal-header"><h3>Вход по номеру</h3><button class="close-modal" data-close="loginModal">&times;</button></div>
      <div id="loginStepPhone">
        <div class="input-group"><span class="input-icon"><i class="fas fa-phone"></i></span><input id="loginPhone" class="input-field" placeholder="+7..." /></div>
        <button id="sendCodeBtn" class="btn">Получить код</button>
      </div>
      <div id="loginStepCode" style="display:none">
        <div class="input-group"><span class="input-icon"><i class="fas fa-key"></i></span><input id="loginCode" class="input-field" placeholder="Код" /></div>
        <div style="display:flex;gap:8px"><button id="verifyCodeBtn" class="btn">Войти</button><button id="cancelCodeBtn" class="btn btn-outline">Отменить</button></div>
        <div class="small">Код показан для демо (в реальном приложении — через SMS)</div>
      </div>
    </div>
  </div>

  <!-- (Тарифов больше нет) -->

  <div id="notification" class="notification"><i class="fas fa-check-circle"></i>&nbsp;<span id="notificationText">Уведомление</span></div>

  <script>
  (function(){
    // ========== State keys ==========
    const PROFILE_KEY='ride_profile_v1', AUTH_KEY='ride_auth_v1', HISTORY_KEY='ride_history_v1';

    // ========== Default tariff constants (hidden, not editable) ==========
    const DEFAULT_TARIFF = { baseFare: 300, perKm: 100, perMin: 10 };

    // ========== Elements ==========
    const profileBadge = document.getElementById('profileBadge');
    const menuBtn = document.getElementById('menuBtn');
    const loginModal = document.getElementById('loginModal');
    const sendCodeBtn = document.getElementById('sendCodeBtn');
    const verifyCodeBtn = document.getElementById('verifyCodeBtn');
    const cancelCodeBtn = document.getElementById('cancelCodeBtn');
    const loginPhone = document.getElementById('loginPhone');
    const loginCode = document.getElementById('loginCode');

    const fromInput = document.getElementById('fromInput');
    const toInput = document.getElementById('toInput');
    const orderBtn = document.getElementById('orderBtn');
    const priceValueEl = document.getElementById('priceValue');
    const manualPriceEl = document.getElementById('manualPrice');
    const offerPriceBtn = document.getElementById('offerPriceBtn');

    const locateMeBtn = document.getElementById('locateMeBtn');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');

    const profileName = document.getElementById('profileName');
    const profilePhone = document.getElementById('profilePhone');
    const profileEmail = document.getElementById('profileEmail');
    const profileBank = document.getElementById('profileBank');
    const profileRole = document.getElementById('profileRole');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const historyList = document.getElementById('historyList');
    const noHistory = document.getElementById('noHistory');
    const clearHistory = document.getElementById('clearHistory');

    const promoInput = document.getElementById('promoInput');
    const applyPromo = document.getElementById('applyPromo');

    const notification = document.getElementById('notification');
    const notificationText = document.getElementById('notificationText');

    // ========== Data helpers ==========
    function loadProfile(){ try{ const s=localStorage.getItem(PROFILE_KEY); return s?JSON.parse(s):{name:'',phone:'',email:'',bank:'',role:'passenger'} }catch{return {name:'',phone:'',email:'',bank:'',role:'passenger'}} }
    function saveProfile(p){ localStorage.setItem(PROFILE_KEY,JSON.stringify(p)) }
    function loadAuth(){ try{ const s=localStorage.getItem(AUTH_KEY); return s?JSON.parse(s):{loggedIn:false,phone:''} }catch{return {loggedIn:false,phone:''}} }
    function saveAuth(a){ localStorage.setItem(AUTH_KEY,JSON.stringify(a)) }
    function loadHistory(){ try{ const s=localStorage.getItem(HISTORY_KEY); return s?JSON.parse(s):[] }catch{return []} }
    function saveHistory(h){ localStorage.setItem(HISTORY_KEY,JSON.stringify(h)) }

    // ========== App state ==========
    let profile = loadProfile();
    let auth = loadAuth();
    let map, userPlacemark, userAccuracyCircle, fromPlacemark, toPlacemark, currentRoute;

    // ========== Init UI ==========
    function uiInit(){
      // profile UI
      profileName.value = profile.name || '';
      profilePhone.value = profile.phone || '';
      profileEmail.value = profile.email || '';
      profileBank.value = profile.bank || '';
      profileRole.value = profile.role || 'passenger';
      logoutBtn.style.display = auth && auth.loggedIn ? 'block' : 'none';

      updateProfileBadge();
      refreshHistoryUI();
      attachEvents();
    }

    function updateProfileBadge(){
      if(auth && auth.loggedIn){
        profileBadge.style.display='flex';
        const text = (profile.name || auth.phone || 'U').trim();
        const initials = text.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase();
        profileBadge.textContent = initials || 'U';
      } else { profileBadge.style.display='none' }
    }

    function refreshHistoryUI(){
      const h = loadHistory();
      historyList.innerHTML='';
      if(!h.length){ noHistory.style.display='block'; return } else noHistory.style.display='none';
      h.slice().reverse().forEach(item=>{
        const el = document.createElement('div'); el.className='history-item';
        el.innerHTML = `<div>
          <div class="history-route">${escapeHtml(item.from)} → ${escapeHtml(item.to)}</div>
          <div class="history-details">${item.date} • ${item.price?item.price+' ₸':'—'}</div>
        </div>
        <div><button class="btn-outline" data-id="${item.id}" onclick="repeatRide(event)">Повторить</button></div>`;
        historyList.appendChild(el);
      });
    }

    // ========== Safe HTML escape ==========
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

    // ========== Attach events ==========
    function attachEvents(){
      // tabs
      document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click',()=>{
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          const id = tab.getAttribute('data-tab')+'Tab';
          document.querySelectorAll('.tab-content').forEach(tc=>tc.style.display='none');
          document.getElementById(id).style.display='block';
        });
      });

      // payments
      document.querySelectorAll('.payment-method').forEach(pm=>{
        pm.addEventListener('click',()=>{ document.querySelectorAll('.payment-method').forEach(x=>x.classList.remove('active')); pm.classList.add('active') });
      });

      // Login flow
      menuBtn.addEventListener('click',()=>openModal('loginModal'));
      document.querySelectorAll('.close-modal').forEach(btn=>{
        btn.addEventListener('click',()=>closeModal(btn.dataset.close));
      });
      cancelCodeBtn.addEventListener('click',()=>{ resetLogin(); closeModal('loginModal') });

      sendCodeBtn.addEventListener('click',()=>{
        const phone = loginPhone.value.trim();
        if(!phone){ show('Введите телефон','error'); return }
        const code = String(Math.floor(100000+Math.random()*900000));
        sessionStorage.setItem('ride_demo_code', code);
        sessionStorage.setItem('ride_demo_phone', phone);
        document.getElementById('loginStepPhone').style.display='none';
        document.getElementById('loginStepCode').style.display='block';
        show('Код отправлен (демо): '+code,'success');
      });

      verifyCodeBtn.addEventListener('click',()=>{
        const got = loginCode.value.trim();
        const real = sessionStorage.getItem('ride_demo_code');
        const phone = sessionStorage.getItem('ride_demo_phone')||'';
        if(!got){ show('Введите код','error'); return }
        if(got === real){
          auth = { loggedIn:true, phone }; saveAuth(auth);
          show('Вход выполнен','success'); closeModal('loginModal'); resetLogin();
          profile = loadProfile();
          if(!profile.name) openModal('profileModal');
          updateProfileBadge();
          logoutBtn.style.display='block';
        } else show('Неверный код','error');
      });

      // profile
      saveProfileBtn.addEventListener('click',()=>{
        const name = profileName.value.trim();
        const phone = profilePhone.value.trim();
        const email = profileEmail.value.trim();
        const bank = profileBank.value;
        const role = profileRole.value;
        if(!name||!phone) { show('Имя и телефон обязательны','error'); return }
        profile = { name, phone, email, bank, role }; saveProfile(profile); show('Анкета сохранена','success'); closeModal('profileModal'); updateProfileBadge();
      });

      logoutBtn.addEventListener('click',()=>{
        auth={loggedIn:false,phone:''}; saveAuth(auth); updateProfileBadge(); show('Вы вышли','success'); logoutBtn.style.display='none';
      });

      // manual price offer
      offerPriceBtn.addEventListener('click', ()=>{
        const val = manualPriceEl.value.trim();
        if(!val || isNaN(Number(val))) { show('Введите корректную цену','error'); return }
        const price = Math.round(Number(val));
        show('Вы предложили цену: '+price+' ₸ — водители увидят ваше предложение', 'success');
        manualPriceEl.value='';
      });

      // order
      orderBtn.addEventListener('click', ()=>{
        const from = fromInput.value.trim();
        const to = toInput.value.trim();
        if(!from || !to) { show('Заполните адреса','error'); return }
        const priceText = priceValueEl.textContent.trim();
        const price = (priceText && priceText!=='—') ? priceText : '';
        orderBtn.disabled=true; orderBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Поиск водителя...';
        setTimeout(()=>{
          const drivers=['Алексей','Мария','Дмитрий']; const d=drivers[Math.floor(Math.random()*drivers.length)];
          show('Водитель '+d+' найден, подъедет через 5 мин','success');
          orderBtn.disabled=false; orderBtn.innerHTML='<i class="fas fa-taxi"></i> Заказать такси';
          const hist = loadHistory();
          const entry = { id:Date.now(), from, to, price: price?price.replace(/\s|₸/g,''):'', date: new Date().toLocaleString() };
          hist.push(entry); saveHistory(hist);
          refreshHistoryUI();
        },1500);
      });

      // promo
      applyPromo.addEventListener('click',()=>{
        const code = (promoInput.value||'').trim().toUpperCase();
        if(!code){ show('Введите промокод','error'); return }
        if(code==='FIRSTRIDE'){ show('Промокод применён: 50% на первую поездку','success'); promoInput.value=''; }
        else show('Промокод не найден','error');
      });

      clearHistory.addEventListener('click', ()=>{ if(confirm('Очистить историю?')){ saveHistory([]); refreshHistoryUI(); show('История очищена','success') } });

      // map controls
      locateMeBtn.addEventListener('click', ()=>locateUser(true));
      zoomInBtn.addEventListener('click', ()=>map && map.setZoom(map.getZoom()+1, {duration:300}));
      zoomOutBtn.addEventListener('click', ()=>map && map.setZoom(map.getZoom()-1, {duration:300}));

      // modal overlay close by click
      document.querySelectorAll('.modal').forEach(m=>{
        m.addEventListener('click', (e)=>{ if(e.target===m){ closeModal(m.id) } });
      });

      // attach window-level functions for repeat button
      window.repeatRide = function(ev){
        const id = ev.target.dataset.id;
        const hist = loadHistory();
        const entry = hist.find(x=>String(x.id)===String(id));
        if(entry){ fromInput.value=entry.from; toInput.value=entry.to; tryBuildRoute(); show('Данные маршрута подставлены','success') }
      }
    }

    // ========== Map init ==========
    function initMap(){
      ymaps.ready(()=>{
        map = new ymaps.Map('map',{ center:[52.19,61.20], zoom:13, controls:['zoomControl','rulerControl','searchControl'] });

        // suggest inputs
        new ymaps.SuggestView('fromInput');
        new ymaps.SuggestView('toInput');

        // place markers
        fromPlacemark = new ymaps.Placemark([52.19,61.20],{hintContent:'Откуда'},{draggable:true,preset:'islands#yellowCircleDotIcon'});
        toPlacemark = new ymaps.Placemark([52.195,61.215],{hintContent:'Куда'},{draggable:true,preset:'islands#dotIcon'});

        fromPlacemark.events.add('dragend', ()=>{ reverseGeocodeSet(fromPlacemark.geometry.getCoordinates(), fromInput); tryBuildRoute(); });
        toPlacemark.events.add('dragend', ()=>{ reverseGeocodeSet(toPlacemark.geometry.getCoordinates(), toInput); tryBuildRoute(); });

        map.geoObjects.add(fromPlacemark).add(toPlacemark);

        // show some taxi markers (decorative)
        for(let i=0;i<6;i++){
          const lat=52.19 + (Math.random()-0.5)*0.05;
          const lon=61.20 + (Math.random()-0.5)*0.05;
          const t = new ymaps.Placemark([lat,lon],{hintContent:'Такси Ride',balloonContent:'Свободно'},{iconLayout:'default#image',iconImageHref:'https://cdn-icons-png.flaticon.com/512/3097/3097140.png',iconImageSize:[36,36],iconImageOffset:[-18,-18]});
          map.geoObjects.add(t);
        }

        // click on map sets destination
        map.events.add('click', (e)=> {
          const coords = e.get('coords');
          toPlacemark.geometry.setCoordinates(coords);
          reverseGeocodeSet(coords,toInput, ()=>{ tryBuildRoute(); show('Точка назначения установлена','success'); });
        });

        // auto-locate user and set "from" if empty
        locateUser(true);

        // build route if fields already filled
        setTimeout(tryBuildRoute,700);
      });
    }

    // ========== Geocode helpers ==========
    function reverseGeocodeSet(coords,inputEl,cb){
      ymaps.geocode(coords).then(res=>{
        const obj = res.geoObjects.get(0);
        if(!obj){ if(cb) cb(); return }
        inputEl.value = obj.getAddressLine();
        if(cb) cb();
      }).catch(()=>{ if(cb) cb(); })
    }

    function geocodeToCoords(value){
      // returns Promise of coords or null
      const parts = (value||'').split(',').map(p=>p.trim());
      if(parts.length===2 && !isNaN(parts[0]) && !isNaN(parts[1])) return Promise.resolve([Number(parts[0]),Number(parts[1])]);
      return ymaps.geocode(value, { results:1 }).then(res=>{ const o=res.geoObjects.get(0); return o?o.geometry.getCoordinates():null }).catch(()=>null);
    }

    // ========== Route building and price ==========
    function tryBuildRoute(){
      const fVal = fromInput.value.trim(); const tVal = toInput.value.trim();
      if(!fVal || !tVal) return;

      Promise.all([geocodeToCoords(fVal), geocodeToCoords(tVal)]).then(values=>{
        if(!values[0] || !values[1]) { show('Не удалось определить точки маршрута','error'); return }
        fromPlacemark.geometry.setCoordinates(values[0]); toPlacemark.geometry.setCoordinates(values[1]);
        buildRoute(values[0],values[1]);
      });
    }

    function buildRoute(fromCoords,toCoords){
      if(currentRoute) map.geoObjects.remove(currentRoute);
      ymaps.route([fromCoords,toCoords], { mapStateAutoApply:true }).then(r=>{
        currentRoute = r;
        map.geoObjects.add(currentRoute);
        const ar = r.getActiveRoute();
        if(!ar){ priceValueEl.textContent='—'; return }
        const distanceObj = ar.properties.get('distance');
        const durationObj = ar.properties.get('duration');
        const distMeters = distanceObj && distanceObj.value ? distanceObj.value : 0;
        const durSec = durationObj && durationObj.value ? durationObj.value : 0;
        const km = (distMeters/1000) || 0;
        const min = Math.ceil((durSec||0)/60);
        const price = calcPrice(km,min);
        priceValueEl.textContent = price.toLocaleString('ru-RU') + ' ₸';
      }).catch(err=>{ console.warn(err); show('Ошибка построения маршрута','error'); priceValueEl.textContent='—' });
    }

    function calcPrice(km,min){
      const base = Number(DEFAULT_TARIFF.baseFare);
      const perKm = Number(DEFAULT_TARIFF.perKm);
      const perMin = Number(DEFAULT_TARIFF.perMin);
      const total = Math.max(base + km*perKm + min*perMin, base);
      return Math.round(total);
    }

    function recalcIfRoute(){ if(currentRoute) tryBuildRoute(); }

    // ========== Geolocation (improved) ==========
    function locateUser(centerMap=false){
      // try navigator.geolocation first
      if (navigator.geolocation) {
        const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 };
        navigator.geolocation.getCurrentPosition(pos => {
          const coords = [pos.coords.latitude, pos.coords.longitude];
          showUserOnMap(coords, pos.coords.accuracy || 50, centerMap);
        }, err => {
          console.warn('navigator.geolocation failed:', err);
          // fallback to ymaps geolocation
          tryYmapsGeo(centerMap);
        }, options);
      } else {
        // fallback to ymaps geolocation
        tryYmapsGeo(centerMap);
      }
    }

    function tryYmapsGeo(centerMap=false){
      // try ymaps geolocation (may be less accurate)
      if (ymaps && ymaps.geolocation) {
        ymaps.geolocation.get({ provider: 'browser', mapStateAutoApply: false }).then(result => {
          const pos = result.geoObjects.position; // [lat, lon]
          if (pos && pos.length === 2) {
            showUserOnMap([pos[0], pos[1]], 100, centerMap);
          } else {
            fallbackCenter(centerMap);
          }
        }).catch(err=>{
          console.warn('ymaps.geolocation failed', err);
          fallbackCenter(centerMap);
        });
      } else {
        fallbackCenter(centerMap);
      }
    }

    function fallbackCenter(centerMap=false){
      const defaultCoords = [52.19, 61.20]; // Житикара
      showUserOnMap(defaultCoords, 500, centerMap);
    }

    function showUserOnMap(coords, accuracy = 50, centerMap=false){
      // remove old
      if (userPlacemark) map.geoObjects.remove(userPlacemark);
      if (userAccuracyCircle) map.geoObjects.remove(userAccuracyCircle);

      userPlacemark = new ymaps.Placemark(coords, { hintContent:'Вы здесь', balloonContent:'Ваше местоположение' }, { preset:'islands#blueCircleIcon' });
      userAccuracyCircle = new ymaps.Circle([coords, accuracy], {}, { fillColor: 'rgba(50,120,200,0.15)', strokeColor: '#3388ff', strokeWidth: 2 });

      map.geoObjects.add(userAccuracyCircle);
      map.geoObjects.add(userPlacemark);

      if (centerMap) map.setCenter(coords, 15);

      // if from input is empty or default -> set from to this address
      if(!fromInput.value || fromInput.value.trim()==='Житикара'){
        reverseGeocodeSet(coords, fromInput, ()=>{ fromPlacemark.geometry.setCoordinates(coords); recalcIfRoute(); });
      }
    }

    // ========== Modals & misc ==========
    function openModal(id){ document.getElementById(id).style.display='flex'; if(id==='loginModal'){ document.getElementById('loginStepPhone').style.display='block'; document.getElementById('loginStepCode').style.display='none'} }
    function closeModal(id){ const el=document.getElementById(id); if(el) el.style.display='none' }
    function resetLogin(){ loginPhone.value=''; loginCode.value=''; sessionStorage.removeItem('ride_demo_code'); sessionStorage.removeItem('ride_demo_phone'); }

    // ========== Notifications ==========
    let notifTimer=null;
    function show(msg, type='success'){
      notificationText.textContent = msg;
      notification.classList.remove('error'); if(type==='error') notification.classList.add('error');
      notification.classList.add('show');
      clearTimeout(notifTimer); notifTimer=setTimeout(()=>notification.classList.remove('show'),3500);
    }

    // ========== Init App ==========
    uiInit();
    initMap();

    // expose small helpers
    window.openModal = openModal;
    window.closeModal = closeModal;

    // finally: recalc price on load if route exists
    setTimeout(()=>{ tryBuildRoute(); },1000);
  })();
  </script>
</body>
</html>